<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Forzamix - Control Calidad + QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --azul: #1a252f; --celeste: #3498db; --verde: #27ae60; --rojo: #c0392b; --fondo: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fondo); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 850px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border-top: 8px solid var(--azul); }
        .seccion { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .db-loader { background: #fff9db; border: 2px dashed #f1c40f; padding: 10px; text-align: center; margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 12px; }
        input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        .grid-superior { display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-bottom: 15px; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        /* Estilos para el QR */
        #qr-result { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 10px; min-height: 150px; }
        #qrcode { margin-bottom: 10px; }
        
        .paso { flex: 1; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; text-align: center; font-weight: bold; color: #adb5bd; }
        .activo { border-color: var(--verde); color: var(--verde); background: #f1fcf4; }
        .btn { padding: 15px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px; margin-top: 5px; }
        #monitor { background: #212529; color: #33ff33; padding: 15px; border-radius: 6px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; margin: 15px 0; }
        .jornada-box { background: #e9ecef; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:var(--azul)">FORZAMIX S.R.L.</h2>
    
    <div class="db-loader">
        <label>1. CARGAR BASE DE DATOS (CSV):</label>
        <input type="file" id="fileInput" accept=".csv" onchange="cargarCSV(this)">
        <p id="statusDB" style="font-size:11px; color:#d35400;">‚ö†Ô∏è Sin art√≠culos cargados.</p>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <div class="seccion">
            <div class="grid-superior">
                <div>
                    <label>BUSCAR PRODUCTO:</label>
                    <input list="listaProductos" id="inputProducto" onchange="vincularCodigo()">
                    <datalist id="listaProductos"></datalist>
                </div>
                <div>
                    <label>Cod:</label>
                    <input type="text" id="codigoProd" readonly style="background:#f1f3f5">
                </div>
            </div>
            <div class="grid-datos">
                <div><label>Orden (OP):</label><input type="text" id="orden"></div>
                <div><label>N¬∞ Lote:</label><input type="text" id="lote"></div>
                <div><label>Peso (Kg):</label><input type="number" id="pesoBatch"></div>
            </div>
            <button id="btnLote" class="btn" style="background:var(--celeste); margin-top:15px" onclick="iniciarLote()">PROCESAR Y GENERAR QR</button>
        </div>

        <div class="seccion" id="qr-result">
            <label>QR DEL √öLTIMO BACHE:</label>
            <div id="qrcode"></div>
            <span id="qr-info" style="font-size:10px; color:var(--gris)">Esperando bache...</span>
        </div>
    </div>

    <div id="monitor">Consola lista...</div>

    <div class="jornada-box">
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px;">
            <span id="txtCant">BATCHES: 0</span>
            <span id="txtPeso">TOTAL D√çA: 0 kg</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn" style="background:var(--azul)" onclick="descargarReporte()">‚¨á DESCARGAR TXT</button>
            <button class="btn" style="background:var(--verde)" onclick="enviarEmail()">üìß ENVIAR REPORTE POR MAIL</button>
        </div>
    </div>
</div>

<script>
    let productosDB = [];
    let historial = [];
    let pesoTotalDia = 0;
    let qrGenerator = new QRCode(document.getElementById("qrcode"), { width: 128, height: 128 });

    function cargarCSV(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const contenido = e.target.result;
            const separador = contenido.split('\n')[0].includes(';') ? ';' : ',';
            const lineas = contenido.split(/\r?\n/);
            const datalist = document.getElementById('listaProductos');
            datalist.innerHTML = "";
            productosDB = [];
            lineas.forEach((l, i) => {
                if (i === 0 || l.trim() === "") return;
                const col = l.split(separador);
                if (col.length >= 2) {
                    const c = col[0].replace(/"/g,"").trim();
                    const d = col[1].replace(/"/g,"").trim();
                    productosDB.push({ c, d });
                    let o = document.createElement('option'); o.value = d;
                    datalist.appendChild(o);
                }
            });
            document.getElementById('statusDB').innerText = `‚úÖ ${productosDB.length} productos listos.`;
        };
        reader.readAsText(file, 'ISO-8859-1');
    }

    function vincularCodigo() {
        const d = document.getElementById('inputProducto').value;
        const p = productosDB.find(x => x.d === d);
        document.getElementById('codigoProd').value = p ? p.c : "";
    }

    function log(msg) {
        document.getElementById('monitor').innerHTML += `> ${msg}<br>`;
        document.getElementById('monitor').scrollTop = 9999;
    }

    function iniciarLote() {
        const p = document.getElementById('inputProducto').value;
        const peso = document.getElementById('pesoBatch').value;
        const lote = document.getElementById('lote').value;
        const cod = document.getElementById('codigoProd').value;
        if(!p || !peso || !lote) return alert("Faltan datos.");

        document.getElementById('btnLote').disabled = true;
        log(`Procesando...`);

        setTimeout(() => {
            const hora = new Date().toLocaleTimeString();
            historial.push({ p, cod, peso: parseFloat(peso), lote, hora });
            pesoTotalDia += parseFloat(peso);
            
            // Generar QR
            const infoQR = `FORZAMIX\nProd: ${p}\nCod: ${cod}\nLote: ${lote}\nPeso: ${peso}kg\nHora: ${hora}`;
            qrGenerator.clear();
            qrGenerator.makeCode(infoQR);
            document.getElementById('qr-info').innerText = `Lote: ${lote} registrado.`;

            document.getElementById('txtCant').innerText = `BATCHES: ${historial.length}`;
            document.getElementById('txtPeso').innerText = `TOTAL D√çA: ${pesoTotalDia} kg`;
            document.getElementById('btnLote').disabled = false;
            log("Batch finalizado y QR generado.");
        }, 2000);
    }

    function descargarReporte() {
        let t = `FORZAMIX - CIERRE ${new Date().toLocaleDateString()}\n`;
        historial.forEach(h => t += `[${h.hora}] ${h.p} | Lote: ${h.lote} | ${h.peso}kg\n`);
        const blob = new Blob([t], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Cierre_${new Date().toLocaleDateString()}.txt`;
        a.click();
    }

    function enviarEmail() {
        if(historial.length === 0) return alert("No hay datos hoy.");
        const destinatario = "calidad@forzamix.com"; // CAMBIAR POR EL MAIL REAL
        const asunto = `Reporte Produccion Forzamix - ${new Date().toLocaleDateString()}`;
        let cuerpo = `Hola, adjunto el reporte de hoy:\n\nTotal de baches: ${historial.length}\nTonelaje total: ${pesoTotalDia} kg\n\nDetalle:\n`;
        historial.forEach(h => cuerpo += `- ${h.hora}: ${h.p} (Lote: ${h.lote}) ${h.peso}kg\n`);
        
        window.location.href = `mailto:${destinatario}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    }
</script>
</body>
</html>

