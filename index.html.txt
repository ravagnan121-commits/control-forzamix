<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Forzamix - Control Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --azul: #1a252f; --celeste: #3498db; --verde: #27ae60; --rojo: #c0392b; --fondo: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fondo); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 900px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border-top: 8px solid var(--azul); }
        .seccion { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .db-loader { background: #fff9db; border: 2px dashed #f1c40f; padding: 10px; text-align: center; margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 12px; }
        input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        .grid-superior { display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-bottom: 15px; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        #qrcode { background: white; padding: 10px; border: 1px solid #ddd; margin-top: 10px; display: inline-block; }
        .btn { padding: 15px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px; margin-top: 5px; }
        #monitor { background: #212529; color: #33ff33; padding: 15px; border-radius: 6px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; margin: 15px 0; }
        .jornada-box { background: #e9ecef; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:var(--azul)">FORZAMIX S.R.L.</h2>
    
    <div class="db-loader">
        <label>1. CARGAR ARTICULOS (CSV):</label>
        <input type="file" id="fileInput" accept=".csv" onchange="cargarCSV(this)">
        <p id="statusDB" style="font-size:11px;">‚ö†Ô∏è Cargue su archivo de art√≠culos para empezar.</p>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <div class="seccion">
            <div class="grid-superior">
                <div>
                    <label>PRODUCTO:</label>
                    <input list="listaProductos" id="inputProducto" onchange="vincularCodigo()">
                    <datalist id="listaProductos"></datalist>
                </div>
                <div><label>Cod:</label><input type="text" id="codigoProd" readonly style="background:#f1f3f5"></div>
            </div>
            <div class="grid-datos">
                <div><label>Orden (OP):</label><input type="text" id="orden"></div>
                <div><label>N¬∞ Lote:</label><input type="text" id="lote"></div>
                <div><label>Peso (Kg):</label><input type="number" id="pesoBatch"></div>
            </div>
            <button id="btnLote" class="btn" style="background:var(--celeste); margin-top:15px" onclick="iniciarLote()">PROCESAR Y GENERAR QR</button>
        </div>

        <div class="seccion" style="text-align:center">
            <label>QR IDENTIFICADOR:</label>
            <div id="qrcode"></div>
            <p id="qr-info" style="font-size:10px; color:#666; margin-top:10px">Esperando registro...</p>
        </div>
    </div>

    <div id="monitor">Sistema con autoguardado activo.</div>

    <div class="jornada-box">
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px;">
            <span id="txtCant">BATCHES HOY: 0</span>
            <span id="txtPeso">PESO TOTAL: 0 kg</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            <button class="btn" style="background:var(--azul)" onclick="descargarReporte()">‚¨á REPORTE TXT</button>
            <button class="btn" style="background:var(--verde)" onclick="enviarEmail()">üìß ENVIAR MAIL</button>
            <button class="btn" style="background:var(--rojo)" onclick="limpiarMemoria()">‚ôª NUEVA JORNADA</button>
        </div>
    </div>
</div>

<script>
    let productosDB = [];
    let historial = JSON.parse(localStorage.getItem('historialForzamix')) || [];
    let qrGenerator = new QRCode(document.getElementById("qrcode"), { width: 140, height: 140 });

    // Al cargar la p√°gina, recuperar datos previos
    window.onload = () => {
        actualizarInterfaz();
        log("Memoria recuperada: " + historial.length + " baches encontrados.");
    };

    function cargarCSV(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const contenido = e.target.result;
            const sep = contenido.split('\n')[0].includes(';') ? ';' : ',';
            productosDB = contenido.split(/\r?\n/).slice(1).map(l => {
                const col = l.split(sep);
                return col.length >= 2 ? { c: col[0].trim(), d: col[1].trim() } : null;
            }).filter(x => x);
            
            const dl = document.getElementById('listaProductos');
            dl.innerHTML = "";
            productosDB.forEach(p => { let o = document.createElement('option'); o.value = p.d; dl.appendChild(o); });
            document.getElementById('statusDB').innerText = `‚úÖ ${productosDB.length} productos cargados.`;
        };
        reader.readAsText(file, 'ISO-8859-1');
    }

    function vincularCodigo() {
        const d = document.getElementById('inputProducto').value;
        const p = productosDB.find(x => x.d === d);
        document.getElementById('codigoProd').value = p ? p.c : "";
    }

    function iniciarLote() {
        const p = document.getElementById('inputProducto').value;
        const peso = document.getElementById('pesoBatch').value;
        const lote = document.getElementById('lote').value;
        const cod = document.getElementById('codigoProd').value;
        if(!p || !peso || !lote) return alert("Complete los datos.");

        document.getElementById('btnLote').disabled = true;
        setTimeout(() => {
            const h = new Date().toLocaleTimeString();
            historial.push({ p, cod, peso: parseFloat(peso), lote, h });
            localStorage.setItem('historialForzamix', JSON.stringify(historial)); // GUARDAR
            
            qrGenerator.clear();
            qrGenerator.makeCode(`FORZAMIX\nLote: ${lote}\nProd: ${p}\nPeso: ${peso}kg`);
            
            actualizarInterfaz();
            document.getElementById('btnLote').disabled = false;
            log("Batch registrado en memoria.");
        }, 1500);
    }

    function actualizarInterfaz() {
        document.getElementById('txtCant').innerText = `BATCHES HOY: ${historial.length}`;
        const total = historial.reduce((sum, item) => sum + item.peso, 0);
        document.getElementById('txtPeso').innerText = `PESO TOTAL: ${total} kg`;
    }

    function limpiarMemoria() {
        if(confirm("¬øSeguro? Se borrar√°n todos los baches de la pantalla para iniciar un nuevo d√≠a.")) {
            localStorage.removeItem('historialForzamix');
            historial = [];
            actualizarInterfaz();
            log("Jornada reiniciada.");
        }
    }

    function log(msg) { document.getElementById('monitor').innerHTML += `> ${msg}<br>`; }

    function descargarReporte() {
        let t = "REPORTE FORZAMIX\n\n";
        historial.forEach(x => t += `${x.h} - ${x.p} - Lote: ${x.lote} - ${x.peso}kg\n`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([t], {type:'text/plain'}));
        a.download = "Reporte.txt"; a.click();
    }

    function enviarEmail() {
        let c = "Reporte Diario Forzamix:\n\n";
        historial.forEach(x => c += `- ${x.h}: ${x.p} (Lote: ${x.lote}) ${x.peso}kg\n`);
        window.location.href = `mailto:calidad@forzamix.com?subject=Reporte%20Produccion&body=${encodeURIComponent(c)}`;
    }
</script>
</body>
</html>

